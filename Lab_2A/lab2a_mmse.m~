clear all
load('2User2AntennaBS.mat');
%% Make vectors.
[y1, y2] = take_real(y1, y2);

%% Account for any delay.
[d1, lags1, cor1] = find_delay(y1, x1);
[d2, lags2, cor2] = find_delay(y2, x2);

% delay the signals
y1 = y1(d1:end);
y2 = y2(d2:end);

%% Plotting the correlation.
figure(1)
plot(lags1, cor1);
title("Cross Correlation At Different Lags for Tx1 Signal")
xlabel("Lags (Bits)")
ylabel("Cross Correlation")

figure(2)
plot(lags2, cor2);
title("Cross Correlation At Different Lags for Tx2 Signal")
xlabel("Lags (Bits)")
ylabel("Cross Correlation")

%% Creating matrices.
x = [x1'; x2'];
y = [y1'; y2'];
%% Estimate the channel response.
H = estimate_channel_response(x1, x2, y1, y2, pulseWidth);

%% Calculate the weight vectors using MMSE.
lambda = var(y1);
w = H' / (H * H' + lambda*eye(2,2));
w1 = w(1,:)';
w2 = w(2,:)';

%% Apply the weight vectors.
% x1_hat = w1' * y;
% x2_hat = w2' * y;

x_hat = w * y;
x1_hat = x_hat(1, :);
x2_hat = x_hat(2, :);

%% Calculate the error.
error_tx1 = calculate_error(x1_hat, x1);
error_tx2 = calculate_error(x2_hat, x2);